<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Distribution</title>
</head>
<body>
    <h1>Расчет распределения конкурсной массы</h1>

    <p>Конкурсная масса: <input type="text" id="cash" /></p>

    <button id="to-creditors-button" type="submit">Добавить кредитора</button>

    <div id="creditors"></div>

    <div id="result"></div>

    <script>
        let cashInput = document.getElementById('cash');
        let creditors = [];

        function validateForm() {
            let cash = parseFloat(cashInput.value);
            if (isNaN(cash) || cash < 0) {
                alert('Конкурсная масса должна быть числом больше или равным нулю');
                return false;
            }
            return true;
        }

        function calculate() {
            if (!validateForm()) {
                return;
            }

            let cash = parseFloat(cashInput.value);
            let totalDebt = 0;
            let ratio = {};

            for (let i = 0; i < creditors.length; i++) {
                let creditor = creditors[i];
                let creditorCash = parseFloat(creditor.cashInput.value);
                let isPercent = creditor.percentOrFeeSelect.value === 'percent';
                let percentOrFee = parseFloat(creditor.valueInput.value);

                creditors[i].cash = creditorCash;
                creditors[i].isPercent = isPercent;
                creditors[i].percentOrFee = percentOrFee;

                totalDebt += creditorCash;
            }

            for (let i = 0; i < creditors.length; i++) {
                let creditor = creditors[i];
                let creditorCash = creditor.cash;
                let isPercent = creditor.isPercent;
                let percentOrFee = creditor.percentOrFee;

                if (isPercent) {
                    ratio[creditor.name] = creditorCash / totalDebt;
                }
            }

            let remainingCash = cash;
            let creditorsGet = {};
            let bankPayments = {};
            let totalFees = {};
            let sumPercent = 0;

            for (let i = 0; i < creditors.length; i++) {
                let creditor = creditors[i];
                let creditorCash = creditor.cash;
                let isPercent = creditor.isPercent;
                let percentOrFee = creditor.percentOrFee;

                if (isPercent) {
                    sumPercent += ratio[creditor.name] * percentOrFee;
                }
            }

            for (let i = 0; i < creditors.length; i++) {
                let creditor = creditors[i];
                let creditorCash = creditor.cash;
                let isPercent = creditor.isPercent;
                let percentOrFee = creditor.percentOrFee;

                let creditorGet;

                if (isPercent) {
                    creditorGet = remainingCash / sumPercent * ratio[creditor.name];
                } else {
                    creditorGet = creditorCash + percentOrFee;
                }

                creditorsGet[creditor.name] = creditorGet;

                if (isPercent) {
                    let fee = creditorGet * percentOrFee / 100;
                    bankPayments[creditor.name] = creditorGet + fee;
                    totalFees[creditor.name] = fee;
                } else {
                    bankPayments[creditor.name] = creditorGet +percentOrFee;
                    totalFees[creditor.name] = percentOrFee;
                }

                remainingCash -= creditorGet;
            }

            let result = document.getElementById('result');
            result.innerHTML = '<h2>Результат</h2>';
            let resultTable = document.createElement('table');
            resultTable.innerHTML = '<tr><th>Кредитор</th><th>Сумма требования</th><th>Сумма погашения</th><th>Сумма с учетом комиссии</th><th>Комиссия</th></tr>';

            for (let i = 0; i < creditors.length; i++) {
                let creditor = creditors[i];

                let row = document.createElement('tr');
                row.innerHTML = '<td>' + creditor.name + '</td><td>' + creditor.cash.toFixed(2) + '</td><td>' + creditorsGet[creditor.name].toFixed(2) + '</td><td>' + bankPayments[creditor.name].toFixed(2) + '</td><td>' + totalFees[creditor.name].toFixed(2) + '</td>';

                resultTable.appendChild(row);
            }

            result.appendChild(resultTable);
        }

        let calculateButton = document.createElement('button');
        calculateButton.type = 'submit';
        calculateButton.innerHTML = 'Рассчитать';
        calculateButton.addEventListener('click', calculate);

        let creditors_amount = 0

        document.getElementById('to-creditors-button').addEventListener('click', function() {
            if (!validateForm()) {
                return;
            }

            let creditorsContainer = document.getElementById('creditors');
            let creditorCount = creditorsContainer.children.length;

            if (creditors_amount === 0) {
                creditorsContainer.appendChild(calculateButton);
            }

            creditors_amount++;

            let creditorDiv = document.createElement('div');
            creditorDiv.id = 'creditor-' + creditorCount;

            let percentOrFeeSelect = document.createElement('select');
            percentOrFeeSelect.name = 'percent-or-fee';
            percentOrFeeSelect.innerHTML = '<option value="percent">Процент</option><option value="fee">Плата</option>';

            let creditorName = 'Кредитор ' + (creditorCount + 1);

            creditorDiv.innerHTML = '<p>' + creditorName + '</p>' +
                '<p>Сумма: <input type="text" name="creditor-' + creditorCount + '-cash" /></p>' +
                '<p>Процент или плата: </p>' + percentOrFeeSelect.outerHTML + '<p>Значение: <input type="number" name="creditor-' + creditorCount + '-value" /></p>';

            creditorsContainer.appendChild(creditorDiv);

            let creditor = {
                name: creditorName,
                cashInput: creditorDiv.querySelector('input[name="creditor-' + creditorCount + '-cash"]'),
                percentOrFeeSelect: creditorDiv.querySelector('select[name="percent-or-fee"]'),
                valueInput: creditorDiv.querySelector('input[name="creditor-' + creditorCount + '-value"]')
            };

            creditors.push(creditor);
        });
    </script>
</body>
</html>
